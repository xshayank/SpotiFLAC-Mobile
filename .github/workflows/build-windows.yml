name: Build Windows

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache-dependency-path: go_backend/go.sum

      - name: Build Go backend for Windows
        working-directory: go_backend
        run: |
          Write-Host "Listing go_backend directory contents..."
          dir
          Write-Host "Creating windows\libs directory..."
          New-Item -ItemType Directory -Force -Path ..\windows\libs
          Write-Host "Building Go backend DLL..."
          go build -v -buildmode=c-shared -o ..\windows\libs\gobackend.dll .
          Write-Host "Build complete"
        shell: powershell

      - name: Verify DLL created
        run: |
          Write-Host "Verifying DLL creation at windows\libs\gobackend.dll..."
          if (Test-Path windows\libs\gobackend.dll) {
            Write-Host "SUCCESS: gobackend.dll created successfully"
            Get-Item windows\libs\gobackend.dll
          } else {
            Write-Error "ERROR: gobackend.dll not found!"
            Write-Host "Listing windows\libs directory:"
            if (Test-Path windows\libs) {
              dir windows\libs
            } else {
              Write-Host "windows\libs directory does not exist"
            }
            exit 1
          }
        shell: powershell

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Create Windows platform (if not exists)
        run: |
          if (!(Test-Path windows\CMakeLists.txt)) {
            Write-Host "Creating Windows platform files..."
            flutter create --platforms=windows .
          } else {
            Write-Host "Windows platform already exists"
          }
        shell: powershell

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Copy Go backend DLL to output
        run: |
          Write-Host "Verifying source DLL exists..."
          if (!(Test-Path windows\libs\gobackend.dll)) {
            Write-Error "ERROR: Source DLL not found at windows\libs\gobackend.dll"
            exit 1
          }
          Write-Host "Verifying destination directory exists..."
          if (!(Test-Path build\windows\x64\runner\Release)) {
            Write-Error "ERROR: Destination directory not found at build\windows\x64\runner\Release"
            exit 1
          }
          Write-Host "Copying gobackend.dll to Release folder..."
          Copy-Item windows\libs\gobackend.dll build\windows\x64\runner\Release\
          Write-Host "SUCCESS: Copied gobackend.dll to Release folder"
        shell: powershell

      - name: Get version
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $VERSION = "${{ github.event.inputs.version }}"
          } else {
            $VERSION = "$env:GITHUB_REF" -replace 'refs/tags/', ''
          }
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $VERSION"
        shell: powershell

      - name: Create distribution archive
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $OUTPUT_DIR = "build\windows\x64\runner\Release"
          $ARCHIVE_NAME = "SpotiFLAC-$VERSION-windows-x64.zip"
          
          Write-Host "Creating distribution archive for version: $VERSION"
          Write-Host "Output directory: $OUTPUT_DIR"
          Write-Host "Archive name: $ARCHIVE_NAME"
          
          # Verify the output directory exists
          if (!(Test-Path $OUTPUT_DIR)) {
            Write-Error "ERROR: Output directory not found at $OUTPUT_DIR"
            exit 1
          }
          
          # Compress the Release folder
          Compress-Archive -Path "$OUTPUT_DIR\*" -DestinationPath $ARCHIVE_NAME
          
          Write-Host "SUCCESS: Created distribution archive: $ARCHIVE_NAME"
          Get-Item $ARCHIVE_NAME
        shell: powershell

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: SpotiFLAC-*.zip

      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: SpotiFLAC-*.zip
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-preview') || contains(steps.version.outputs.version, '-beta') || contains(steps.version.outputs.version, '-rc') || contains(steps.version.outputs.version, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
